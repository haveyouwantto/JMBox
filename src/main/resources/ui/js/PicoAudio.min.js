var PicoAudio=function(){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),e}function n(e){return n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function r(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function o(e,t,a){return o=r()?Reflect.construct:function(e,t,a){var i=[null];i.push.apply(i,t);var n=new(Function.bind.apply(e,i));return a&&s(n,a.prototype),n},o.apply(null,arguments)}function u(e){var t="function"==typeof Map?new Map:void 0;return u=function(e){if(null===e||(a=e,-1===Function.toString.call(a).indexOf("[native code]")))return e;var a;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return o(e,arguments,n(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),s(i,e)},u(e)}function c(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function l(e){for(var t in this.debug=!1,this.isStarted=!1,this.isPlayed=!1,this.settings={masterVolume:1,generateVolume:.15,tempo:120,basePitch:440,resolution:480,isWebMIDI:!1,WebMIDIWaitTime:1e3,WebMIDIPortOutputs:null,WebMIDIPortOutput:null,WebMIDIPort:-1,WebMIDIPortSysEx:!0,isReverb:!0,reverbVolume:1.5,initReverb:10,isChorus:!0,chorusVolume:.5,isCC111:!0,loop:!1,isSkipBeginning:!1,isSkipEnding:!0,holdOnValue:64,maxPoly:-1,maxPercPoly:-1,isOfflineRendering:!1,isSameDrumSoundOverlap:!1,baseLatency:-1,soundQuality:0,preserveSmfData:!1},m(this,e,"debug"),this.settings)m(this.settings,e,t);this.events=[],this.trigger={isNoteTrigger:!0,play:function(){},stop:function(){},noteOn:function(){},noteOff:function(){},songEnd:function(){}},this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:100,updateBufMaxTime:350,updateIntervalTime:0,latencyLimitTime:0},this.hashedDataList=[],this.hashedMessageList=[],this.playData=null,this.channels=[],this.tempoTrack=[{timing:0,value:120},{timing:0,value:120}],this.cc111Time=-1,this.onSongEndListener=null,this.baseLatency=.01;for(var a=0;a<17;a++)this.channels.push([0,0,1]);e&&e.audioContext&&this.init(e)}function m(e,t,a){t&&null!=t[a]&&e&&null!=e[a]&&(e[a]=t[a])}var h=function(){function e(){t(this,e)}return i(e,null,[{key:"resetSeed",value:function(){this.init=!0,this.x=123456789,this.y=362436069,this.z=521288629,this.w=8867512}},{key:"random",value:function(){this.init||this.resetSeed();var e=this.x^this.x<<11;this.x=this.y,this.y=this.z,this.z=this.w;var t=this.w=this.w^this.w>>>19^e^e>>>8;return t=Math.abs(t)/2147483648%2}}]),e}(),p=function(){function e(){t(this,e)}return i(e,null,[{key:"lerpWave",value:function(e,t){var a=e.getChannelData(0).length,i=t[0].length;if(a==i)for(var n=0;n<2;n++)for(var s=e.getChannelData(n),r=t[n],o=0;o<a;o++)s[o]=r[o];else for(var u=i/a,c=0;c<2;c++)for(var l=e.getChannelData(c),m=t[c],h=0;h<a;h++){var p=h*u,T=Math.trunc(p),f=(T+1)%i,g=p-T,v=m[T]*(1-g)+m[f]*g;l[h]=v}}}]),e}();function T(e){if(!this.isStarted){this.isStarted=!0;var t=e&&e.audioContext,a=e&&e.picoAudio,i=window.AudioContext||window.webkitAudioContext;this.context=t||new i,this.masterGainNode=this.context.createGain(),this.masterGainNode.gain.value=this.settings.masterVolume,this.compressor=this.context.createDynamicsCompressor(),this.compressor.threshold.value=-12;var n=this.context.sampleRate,s=n>=48e3?48e3:n;if(a&&a.whitenoise)this.whitenoise=a.whitenoise;else{h.resetSeed();for(var r=1*n,o=1*s,u=[],c=0;c<2;c++){u.push(new Float32Array(o));for(var l=u[c],m=0;m<o;m++){var T=h.random();l[m]=2*T-1}}this.whitenoise=this.context.createBuffer(2,r,n),p.lerpWave(this.whitenoise,u)}if(a&&a.impulseResponse)this.impulseResponse=a.impulseResponse;else{h.resetSeed();for(var f=3.5*n,g=3.5*s,v=[],d=0;d<2;d++){v.push(new Float32Array(g));for(var y=v[d],b=0;b<g;b++){var A=(g-b)/g,V=b/s,k=(V<.03?0:A)*(V>=.03&&V<.031?2*A:A)*(V>=.04&&V<.042?1.5*A:A)*(V>=.05&&V<.054?1.25*A:A)*h.random()*.2*Math.pow(A-.03,4);y[b]=k}}this.impulseResponse=this.context.createBuffer(2,f,this.context.sampleRate),p.lerpWave(this.impulseResponse,v)}this.convolver=this.context.createConvolver(),this.convolver.buffer=this.impulseResponse,this.convolver.normalize=!0,this.convolverGainNode=this.context.createGain(),this.convolverGainNode.gain.value=this.settings.reverbVolume,this.convolver.connect(this.convolverGainNode),this.convolverGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.compressor),this.compressor.connect(this.context.destination),this.chorusDelayNode=this.context.createDelay(),this.chorusGainNode=this.context.createGain(),this.chorusOscillator=this.context.createOscillator(),this.chorusLfoGainNode=this.context.createGain(),this.chorusDelayNode.delayTime.value=.025,this.chorusLfoGainNode.gain.value=.01,this.chorusOscillator.frequency.value=.05,this.chorusGainNode.gain.value=this.settings.chorusVolume,this.chorusOscillator.connect(this.chorusLfoGainNode),this.chorusLfoGainNode.connect(this.chorusDelayNode.delayTime),this.chorusDelayNode.connect(this.chorusGainNode),this.chorusGainNode.connect(this.masterGainNode),this.chorusOscillator.start(0),this.baseLatency=this.context.baseLatency||this.baseLatency,-1!=this.settings.baseLatency&&(this.baseLatency=this.settings.baseLatency)}}var f=function(){function e(){t(this,e)}return i(e,null,[{key:"now",value:function(){return null==this._now&&(void 0===window.performance?this._now=function(){return window.Date.now()}:this._now=function(){return window.performance.now()}),this._now()}}]),e}(),g=9007199254740991;function v(e){if(this.debug)var t=f.now();if(this.states.isPlaying&&this.stop(),this.playData=e,this.settings.resolution=e.header.resolution,this.settings.tempo=e.tempo||120,this.tempoTrack=e.tempoTrack,this.cc111Time=e.cc111Time,this.firstNoteOnTiming=e.firstNoteOnTiming,this.lastNoteOffTiming=e.lastNoteOffTiming,this.firstNoteOnTime=e.firstNoteOnTime,this.lastNoteOffTime=e.lastNoteOffTime,this.lastEventTiming=e.lastEventTiming,this.lastEventTime=e.lastEventTime,this.initStatus(),this.debug){var a=f.now();console.log("setData time",a-t)}return this}function d(e,t){if((!this.settings.isWebMIDI||null==this.states.webMIDIWaitState)&&(this.stop(e),this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:this.states.webMIDIStopTime,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:this.states.updateBufTime,updateBufMaxTime:this.states.updateBufMaxTime,updateIntervalTime:this.states.updateIntervalTime,latencyLimitTime:this.states.latencyLimitTime,noteOnAry:[],noteOffAry:[]},this.settings.isWebMIDI&&!t)){if(e)return;if(null==this.settings.WebMIDIPortOutput)return void this.startWebMIDI();if(this.settings.WebMIDIPortSysEx)this.settings.WebMIDIPortOutput.send([240,126,127,9,1,247]);else for(var a=0;a<16;a++)this.settings.WebMIDIPortOutput.send([192+a,0]),this.settings.WebMIDIPortOutput.send([224+a,0,64]),this.settings.WebMIDIPortOutput.send([176+a,100,0]),this.settings.WebMIDIPortOutput.send([176+a,101,0]),this.settings.WebMIDIPortOutput.send([176+a,6,2]),this.settings.WebMIDIPortOutput.send([176+a,100,1]),this.settings.WebMIDIPortOutput.send([176+a,96,0]),this.settings.WebMIDIPortOutput.send([176+a,97,64]),this.settings.WebMIDIPortOutput.send([176+a,7,100]),this.settings.WebMIDIPortOutput.send([176+a,10,64]),this.settings.WebMIDIPortOutput.send([176+a,11,127]),this.settings.WebMIDIPortOutput.send([176+a,98,0]),this.settings.WebMIDIPortOutput.send([176+a,99,0]),this.settings.WebMIDIPortOutput.send([176+a,122,0])}}var y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(l,e);var a,o,u=(a=l,o=r(),function(){var e,t=n(a);if(o){var i=n(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return c(this,e)});function l(){return t(this,l),u.apply(this,arguments)}return i(l,null,[{key:"delete",value:function(e,t){t==e.length-1?e.pop():0==t?e.shift():e.splice(t,1)}}]),l}(u(Array)),b=function(){function e(){t(this,e)}return i(e,null,[{key:"getInt",value:function(e,t,a){for(var i=0,n=t;n<a;n++)i=(i<<8)+e[n];return i}},{key:"variableLengthToInt",value:function(e,t,a){for(var i=t,n=0;i<a-1&&e[i]>=128;)i<t+4&&(n=(n<<7)+(e[i]-128)),i++;return[n=(n<<7)+e[i],++i-t]}},{key:"chIndicesInsert",value:function(e,t,a,i,n){var s=t.indices;if(t.indicesLength>=4&&a<s[t.indicesFoot])for(;-1!=t.indicesCur;){if(a<s[t.indicesCur]){t.indicesCur==t.indicesHead?t.indicesHead=t.indicesLength:s[t.indicesPre+3]=t.indicesLength,s[t.indicesLength]=a,s[t.indicesLength+1]=n,s[t.indicesLength+2]=i,s[t.indicesLength+3]=t.indicesCur,t.indicesPre=t.indicesLength,t.indicesLength+=4;break}t.indicesPre=t.indicesCur,t.indicesCur=s[t.indicesCur+3]}else t.indicesLength>=4?s[t.indicesFoot+3]=t.indicesLength:t.indicesHead=0,t.indicesFoot=t.indicesLength,s[t.indicesLength]=a,s[t.indicesLength+1]=n,s[t.indicesLength+2]=i,s[t.indicesLength+3]=-1,t.indicesLength+=4}}]),e}(),A=function(){function e(){t(this,e)}return i(e,null,[{key:"init",value:function(e,t){this.updatePreTime=f.now(),this.pPreTime=f.now(),this.cPreTime=1e3*e.context.currentTime,this.pTimeSum=0,this.cTimeSum=0,this.cnt=0,this.initCurrentTime=t}},{key:"update",value:function(e){var t=this,a=e.context,i=e.settings,n=e.states,s=e.baseLatency,r=f.now(),o=this.updatePreTime,u=this.pPreTime,c=this.cPreTime,l=this.pTimeSum,m=this.cTimeSum,h=this.cnt,p=r-o,T=r,g=1e3*a.currentTime;l+=T-u,m+=g-c,u=T,c=g;var v=l-m;if(n.latencyTime=v,v>=100?(n.latencyLimitTime+=v,m+=100):v<=-100?m=l:n.latencyLimitTime>0&&(n.latencyLimitTime-=.003*p,n.latencyLimitTime<0&&(n.latencyLimitTime=0)),n.updateIntervalTime=p,n.updateBufTime<p?n.updateBufTime=p:(n.updateBufMaxTime>350&&(n.updateBufMaxTime-=.002*n.updateBufMaxTime),n.updateBufTime<20&&(n.updateBufTime+=5e-4*n.updateBufTime),n.updateBufMaxTime>=10&&n.updateBufMaxTime<340&&(n.updateBufMaxTime+=.002*n.updateBufMaxTime)),n.updateBufTime>n.updateBufMaxTime){if(p>=900&&n.latencyLimitTime<=150)n.updateBufMaxTime+=p;else{var d=p-n.updateBufMaxTime;n.updateBufTime=n.updateBufMaxTime,n.updateBufMaxTime<10?(n.updateBufTime=n.updateBufMaxTime,n.updateBufMaxTime*=1.25):n.updateBufMaxTime+=d/2}n.updateBufMaxTime>1100&&(n.updateBufMaxTime=1100)}n.latencyLimitTime>150&&(m=l,n.latencyLimitTime-=5,n.latencyLimitTime>1e3&&(n.latencyLimitTime=1e3),n.updateBufMaxTime=1,n.updateBufTime=1,p=1);for(var y=0;y<16;y++){for(var A=e.playData.channels[y].notes,V=n.playIndices[y],k=function(){var r=A[V],o=0==h?t.initCurrentTime-n.startTime:a.currentTime-n.startTime;if(o>=r.stopTime)return"continue";if(0==h&&o>r.startTime+s)return"continue";if(o<r.startTime-n.updateBufTime/1e3)return"break";if(!i.isWebMIDI){if(n.stopFuncs.length>=350&&n.updateBufTime<1e3&&(n.updateBufTime=12,n.updateBufMaxTime=n.updateBufTime),-1!=i.maxPoly||-1!=i.maxPercPoly){var u=0,c=0;if(n.stopFuncs.forEach((function(e){e.note&&(9!=e.note.channel?r.start>=e.note.start&&r.start<e.note.stop&&u++:r.start==e.note.start&&c++)})),9!=r.channel&&u>=i.maxPoly||9==r.channel&&c>=i.maxPercPoly)return"continue"}var l=9!=r.channel?e.createNote(r):e.createPercussionNote(r);if(!l)return"continue";e.pushFunc({note:r,stopFunc:l})}n.noteOnAry.push(r)};V<A.length;V++){var I=k();if("continue"!==I&&"break"===I)break}n.playIndices[y]=V}if(this.checkNoteOn(e),this.checkNoteOff(e),i.isWebMIDI&&null!=i.WebMIDIPortOutput){for(var R=e.playData.messages,M=e.playData.smfData,D=n.playIndices[16];D<R.length;D++){var w=R[D],P=a.currentTime-n.startTime;if(!(P>w.time+i.WebMIDIWaitTime/1e3)){if(P<w.time-i.WebMIDIWaitTime/1e3)break;var x=w.smfPtrLen,N=w.smfPtr,O=w.time,S=M[N];if(255!=S)try{if(240==S||247==S){if(i.WebMIDIPortSysEx){var W=b.variableLengthToInt(M,N+1,N+1+4),L=N+1+W[1],E=L+W[0],q=new Uint8Array(1+W[0]);q[0]=S;for(var B=E-L,C=0;C<B;C++)q[C+1]=M[L+C];i.WebMIDIPortOutput.send(q,1e3*(O-a.currentTime+f.now()/1e3+n.startTime))}}else{for(var F=[],G=0;G<x;G++)F.push(M[N+G]);i.WebMIDIPortOutput.send(F,1e3*(O-a.currentTime+f.now()/1e3+n.startTime))}}catch(e){console.log(e,N,x,O,S)}}}n.playIndices[16]=D}h++,this.updatePreTime=r,this.pPreTime=u,this.cPreTime=c,this.pTimeSum=l,this.cTimeSum=m,this.cnt=h}},{key:"checkNoteOn",value:function(e){for(var t=e.context,a=e.trigger,i=e.states,n=e.states.noteOnAry,s=e.states.noteOffAry,r=0;r<n.length;r++){var o=n[r],u=t.currentTime-i.startTime;o.startTime-u<=0&&(y.delete(n,r),s.push(o),a.isNoteTrigger&&a.noteOn(o),e.fireEvent("noteOn",o),r--)}}},{key:"checkNoteOff",value:function(e){for(var t=e.context,a=e.trigger,i=e.states,n=e.states.noteOffAry,s=0;s<n.length;s++){var r=n[s],o=t.currentTime-i.startTime;(9!=r.channel&&r.stopTime-o<=0||9==r.channel&&r.drumStopTime-o<=0)&&(y.delete(n,s),e.clearFunc("note",r),a.isNoteTrigger&&a.noteOff(r),e.fireEvent("noteOff",r),s--)}}}]),e}();function V(e){var t=this,a=this.context,i=this.settings,n=this.trigger,s=this.states;if(a.resume&&a.resume(),!s.isPlaying){if(i.isWebMIDI&&!e){if("completed"!=s.webMIDIWaitState){if("waiting"!=s.webMIDIWaitState){s.webMIDIWaitState="waiting";var r=i.WebMIDIWaitTime-1e3*(a.currentTime-s.webMIDIStopTime);0==s.webMIDIStopTime&&(r=i.WebMIDIWaitTime),setTimeout((function(){s.webMIDIWaitState="completed",s.isPlaying=!1,t.play()}),r)}return}s.webMIDIWaitState=null}var o,u=a.currentTime;if(this.isPlayed=!0,s.isPlaying=!0,s.startTime=s.startTime||s.stopTime?s.startTime+u-s.stopTime:u,s.stopFuncs=[],i.isSkipBeginning){var c=this.firstNoteOnTime;-s.startTime+u<c&&this.setStartTime(c+s.startTime-u)}var l=1e3*(this.getTime(g)-a.currentTime+s.startTime);o=setTimeout((function e(){t.clearFunc("rootTimeout",o),t.getTime(g)-a.currentTime+s.startTime<=0?(n.songEnd(),t.onSongEnd(),t.fireEvent("songEnd")):(o=setTimeout(e,1),t.pushFunc({rootTimeout:o,stopFunc:function(){clearTimeout(o)}}))}),l),this.pushFunc({rootTimeout:o,stopFunc:function(){clearTimeout(o)}}),n.play(),this.fireEvent("play"),A.init(this,u);var m=setInterval((function(){A.update(t)}),1);this.pushFunc({rootTimeout:m,stopFunc:function(){clearInterval(m)}})}}function k(e){var t=this,a=this.states,i=this.settings;if(0!=a.isPlaying){if(a.isPlaying=!1,a.stopTime=this.context.currentTime,a.stopFuncs.forEach((function(e){e.stopFunc()})),a.stopFuncs=[],a.playIndices.forEach((function(e,t,a){a[t]=0})),a.noteOnAry=[],a.noteOffAry=[],this.settings.isWebMIDI){if(e)return;if(null==this.settings.WebMIDIPortOutput)return;a.webMIDIStopTime=this.context.currentTime,setTimeout((function(){for(var e=0;e<16;e++)t.settings.WebMIDIPortOutput.send([176+e,120,0])}),i.WebMIDIWaitTime)}this.trigger.stop(),this.fireEvent("pause"),this.fireEvent("stop")}}function I(e,t,a,i,n){var s=this,r=this.settings,o=this.context,u=this.states.startTime,c=this.baseLatency,l=i?0:e.channel||0,m=e.velocity*Number(i?1:null!=this.channels[l][2]?this.channels[l][2]:1)*r.generateVolume,h=!0;if(m<=0)return{isGainValueZero:!0};var p=m*((e.expression?e.expression[0].value:100)/127),T=o.createGain();if(T.gain.value=p,a?e.expression&&e.expression.forEach((function(e){var t=m*(e.value/127);t>0&&(h=!1);var a=Math.max(0,e.time+u+c);T.gain.setValueAtTime(t,a)})):p>0&&(h=!1),h)return{isGainValueZero:!0};var f=e.startTime+u+c,g=e.stopTime+u+c,v=r.basePitch*Math.pow(Math.pow(2,1/12),(e.pitch||69)-69),d=t?o.createBufferSource():o.createOscillator(),y=o.createStereoPanner?o.createStereoPanner():o.createPanner?o.createPanner():{pan:{setValueAtTime:function(){}}},b=o.createGain(),A=o.createGain();t?(d.loop=!0,d.buffer=this.whitenoise):(d.type=e.type||"sine",d.detune.value=0,d.frequency.value=v,e.pitchBend&&e.pitchBend.forEach((function(t){var a=Math.max(0,t.time+u+c);d.frequency.setValueAtTime(r.basePitch*Math.pow(Math.pow(2,1/12),e.pitch-69+t.value),a)})));var V,k,I=e.pan&&64!=e.pan[0].value?e.pan[0].value/127*2-1:0;if(function(e,t,a){if(e.createStereoPanner)a>1&&(a=1),t.pan.value=a;else if(e.createPanner){var i=R(a);t.panningModel="equalpower",t.setPosition(i.x,i.y,i.z)}}(o,y,I),o.createStereoPanner||o.createPanner){var M=!0;if(o.createStereoPanner)e.pan&&e.pan.forEach((function(e){if(M)M=!1;else{var t=Math.min(1,64==e.value?0:e.value/127*2-1),a=Math.max(0,e.time+u+c);y.pan.setValueAtTime(t,a)}}));else if(o.createPanner)if(y.positionX){var D=!0;e.pan&&e.pan.forEach((function(e){if(D)D=!1;else{var t=R(64==e.value?0:e.value/127*2-1),a=Math.max(0,e.time+u+c);y.positionX.setValueAtTime(t.x,a),y.positionY.setValueAtTime(t.y,a),y.positionZ.setValueAtTime(t.z,a)}}))}else e.pan&&e.pan.forEach((function(e){if(M)M=!1;else{var t=setTimeout((function(){s.clearFunc("pan",t);var a=R(Math.min(1,64==e.value?0:e.value/127*2-1));y.setPosition(a.x,a.y,a.z)}),1e3*(e.time+u+c-o.currentTime));s.pushFunc({pan:t,stopFunc:function(){clearTimeout(t)}})}}));d.connect(y),y.connect(T)}else d.connect(T);if(T.connect(b),b.connect(A),A.connect(this.masterGainNode),!t&&e.modulation&&(e.modulation.length>=2||e.modulation[0].value>0)){V=o.createOscillator(),k=o.createGain();var w=!0;e.modulation&&e.modulation.forEach((function(e){if(w)w=!1;else{var t=Math.min(1,e.value/127),a=Math.max(0,e.time+u+c);k.gain.setValueAtTime(10*v/440*t,a)}}));var P=Math.min(1,e.modulation?e.modulation[0].value/127:0);k.gain.value=10*v/440*P,V.frequency.value=6,V.connect(k),k.connect(d.frequency)}if(this.settings.isReverb&&e.reverb&&(e.reverb.length>=2||e.reverb[0].value>0)){var x=this.convolver,N=o.createGain(),O=!0;e.reverb&&e.reverb.forEach((function(e){if(O)O=!1;else{var t=Math.min(1,e.value/127),a=Math.max(0,e.time+u+c);N.gain.setValueAtTime(t,a)}}));var S=Math.min(1,e.reverb?e.reverb[0].value/127:0);N.gain.value=S,b.connect(A),A.connect(N),N.connect(x)}if(this.settings.isChorus&&e.chorus&&(e.chorus.length>=2||e.chorus[0].value>0)){var W=this.chorusDelayNode,L=o.createGain(),E=!0;e.chorus&&e.chorus.forEach((function(e){if(E)E=!1;else{var t=Math.min(1,e.value/127),a=Math.max(0,e.time+u+c);L.gain.setValueAtTime(t,a)}}));var q=Math.min(1,e.chorus?e.chorus[0].value/127:0);L.gain.value=q,b.connect(A),A.connect(L),L.connect(W)}return V&&(V.start(f),this.stopAudioNode(V,g,k)),d.start(f),t||i||n||this.stopAudioNode(d,g,A),{start:f,stop:g,pitch:v,channel:l,velocity:m,oscillator:d,panNode:y,gainNode:b,stopGainNode:A,isGainValueZero:!1}}function R(e){e>1&&(e=1);var t={},a=90*e;return t.x=Math.sin(a*(Math.PI/180)),t.y=0,t.z=-Math.cos(a*(Math.PI/180)),t}var M=[[1,.8,.45,.096,.056,.0041,.095,.11,.052,.024,.018,.0025,.017,.023,.0098,.0075],[1,.3,.19,.063,.054,.069,.1,.048,.017,.038,.011,.0021,.0089,.011,.0018,.011],[.8,.85,1,.13,.033,.21,.052,.0053,.11,.057,.076,.009,.035,.038,.036,.005],[1,.9,.33,.086,.086,.022,.03,.0079,.019,.0099,.017,.0033,.0059,.0027,.0078,.0036],[1,.58,.16,.024,.0018,.0033,.0032,.0023,.0023,.0022,.0018,.002,.0017,.0014,.0012,.0013],[1,.5,.21,.043,.012,.0053,.0031,.0028,.0028,.0021,.12,.0037,.12,93e-5,.0013,.0023],[1,.42,.2,.028,.54,.38,.28,.035,.31,.45,.13,.018,.18,.32,.12,.024],[1,.41,.56,.13,.21,.25,.3,.35,.23,.25,.096,.13,.17,.1,.044,.08],[1,.015,.0083,.0059,.0045,.0036,.032,.003,.0026,.0024,.0022,.002,.0018,.0021,.0016,.0014],[1,.015,.0081,.0063,.0053,.0083,.0053,.0067,.0077,.0031,.0025,.0021,.0016,.037,.0013,.074],[1,.015,.0084,.0059,.0045,.026,.016,.003,.0025,.0023,.0021,.0019,.0018,.014,.0014,.0013],[1,.011,.0052,.26,.0083,.0061,.005,.0039,.0036,.0032,.003,.0029,.0029,.0034,.22,6e-4],[1,.012,.011,.29,.0059,.0048,.004,.0028,.0028,.0034,.051,.0035,.0021,.0016,.0082,.0015],[1,.012,.0067,.0045,.0036,.0032,.0024,.0023,.0019,.0018,.0017,.0015,.0013,.0012,.0013,.0012],[1,.07,.093,.074,.054,.47,.0019,.65,.0017,.0062,.011,.01,.096,.0025,.21,.0032],[1,.58,.58,.51,.59,.077,.13,.17,.11,.33,.24,.32,.0076,.13,.094,.17],[1,.09,.0055,.45,.011,.099,.01,.22,.0093,.015,.006,.0029,.0052,.0042,.0044,.04],[.036,1,.006,.0037,.0027,.0021,.0018,.0015,.0014,.0014,.0013,.0011,97e-5,95e-5,87e-5,83e-5],[1,.64,.016,.051,.017,.0088,.0021,.0031,.0037,.0049,.0036,.0038,.0029,.0032,.0023,.0025],[.48,1,.29,.38,.015,.1,.0074,.087,.027,.0027,.004,.034,.0032,.003,.0059,.024],[.46,1,.14,.42,.12,.095,.051,.055,.029,.031,.023,.019,.0097,.012,.0089,.017],[.46,.84,1,.15,.17,.22,.15,.047,.018,.0035,.023,.035,.028,.016,.0044,.0019],[.69,.55,1,.018,.48,.0084,.2,.0081,.14,.16,.13,.0074,.074,.15,.09,.0029],[1,.68,.68,.73,.23,.24,.19,.26,.18,.13,.12,.12,.029,.033,.048,.02],[1,.82,.65,.057,.5,.19,.23,.07,.055,.048,.038,.022,.031,.022,.011,.025],[1,.34,.081,.096,.17,.16,.29,.22,.053,.046,.06,.028,.078,.043,.04,.073],[1,.68,.014,.12,.067,.088,.06,.0078,.0044,.03,.011,.0031,.009,.013,.0027,82e-5],[.91,.81,1,.058,.75,.4,.12,.17,.06,.08,.051,.18,.13,.061,.15,.067],[1,.65,.17,.044,.013,.0047,.0042,.0036,.0031,.0031,.0027,.0026,.002,.0021,.0021,.0019],[.33,.53,1,.15,.24,.045,.15,.082,.16,.04,.052,.037,.042,.062,.047,.056],[.51,.57,1,.26,.16,.12,.081,.063,.092,.045,.024,.039,.0089,.013,.023,.024],[.0016,.021,.021,1,.014,.01,.0069,.015,.0038,.011,.011,.24,.025,.0082,.0079,.013],[1,.64,.27,.028,.085,.03,.025,.012,.022,.0074,.01,.0038,.0088,.0039,.0063,.0011],[.6,1,.5,.13,.036,.013,.0089,.0094,.0059,.0062,.0059,.0042,.0028,.0013,.002,.0029],[.2,1,.16,.018,.0054,93e-5,.0032,.0054,.0046,.0024,.0058,.004,.0014,.0014,43e-5,53e-5],[.69,1,.9,.17,.037,.011,.0054,.0034,.0028,.0026,.0024,.0021,.0021,.0018,.002,.0016],[1,.58,.13,.22,.07,.0084,.032,.035,.017,.025,.017,.01,.02,.061,.064,.0022],[1,.95,.53,.14,.04,.019,.0029,.13,.21,.004,.16,.16,.0025,.038,.0033,.024],[1,.58,.4,.33,.24,.17,.12,.087,.063,.045,.032,.023,.018,.015,.011,.0092],[.33,.64,1,.35,.16,.093,.071,.031,.03,.014,.017,.0065,.0075,.0051,.0062,.0037],[1,.17,.52,.35,.41,.3,.26,.15,.11,.019,.012,.021,.024,.025,.013,.0011],[.49,1,.49,.12,.054,.11,.063,.041,.064,.031,.028,.023,.0099,.016,.02,.0094],[1,.57,.38,.42,.38,.38,.29,.19,.29,.39,.14,.057,.14,.13,.13,.036],[.71,1,.9,.63,.75,.37,.4,.4,.38,.084,.15,.11,.15,.045,.046,.048],[.41,1,.72,.74,.79,.086,.36,.32,.32,.14,.13,.063,.12,.04,.057,.022],[1,.62,.37,.024,.087,.05,.019,.031,.0055,.017,.0038,.0085,.0019,.0075,.0012,.0043],[1,.15,.17,.13,.055,.0037,.023,.004,.012,.018,.0087,.0017,.006,.0012,.0015,.0016],[1,.0082,.096,.0089,.024,.0038,.025,.002,.012,.0031,.0029,.0017,73e-5,.0018,.0018,.0013],[1,.45,.65,.078,.23,.36,.23,.053,.15,.11,.044,.013,.046,.057,.032,.0078],[1,.51,.21,.074,.19,.24,.079,.077,.092,.05,.029,.031,.0094,.027,.037,.021],[1,.34,.19,.082,.055,.038,.026,.017,.01,.0055,.0027,.0015,84e-5,24e-5,16e-5,98e-5],[1,.32,.13,.082,.045,.042,.024,.021,.014,.012,.009,.004,.0028,7e-4,.0014,53e-5],[.17,1,.089,.01,.0069,.0048,.004,.0034,.003,.0028,.0025,.0024,.0024,.0019,.0017,.0016],[1,.33,.19,.042,.046,.015,.0083,.0095,.0082,.0054,.0066,.0034,.0025,.0029,.0024,.001],[1,.15,.013,.0085,.0061,.0055,.0049,.0041,.0035,.0031,.003,.0028,.0025,.0025,.0019,.0019],[.57,1,.65,.53,.57,.5,.52,.54,.46,.46,.38,.26,.3,.32,.3,.32],[.88,1,.82,.57,.54,.35,.4,.37,.32,.28,.24,.14,.13,.13,.13,.12],[1,.53,.27,.14,.09,.054,.03,.016,.0096,.0086,.0095,.0049,.004,.0024,.0015,.0027],[.39,1,.68,.32,.17,.078,.032,.011,.0021,.0022,.0031,.0033,.0029,.0034,.0027,.0021],[1,.27,.31,.63,.068,.51,.18,.3,.17,.068,.28,.18,.15,.086,.037,.039],[1,.46,.1,.017,.0099,.0053,.0037,.0033,.0031,.0023,.0012,31e-5,73e-5,94e-5,52e-5,39e-5],[1,.86,.59,.32,.094,.15,.19,.26,.24,.2,.14,.059,.054,.06,.071,.048],[.47,1,.75,.42,.3,.2,.12,.13,.19,.23,.26,.31,.34,.35,.34,.33],[1,.53,.23,.079,.048,.031,.024,.022,.019,.012,.0041,.0046,.0049,.003,.0013,.002],[1,.65,.28,.23,.18,.14,.086,.13,.075,.062,.035,.046,.024,.026,.021,.023],[1,.89,.85,.78,.8,.72,.66,.65,.62,.5,.37,.27,.27,.22,.15,.089],[1,.36,.12,.25,.23,.2,.13,.098,.065,.093,.082,.075,.064,.054,.036,.02],[1,.61,.36,.28,.2,.16,.27,.26,.16,.12,.12,.056,.066,.088,.081,.088],[.26,.48,1,.98,.88,.45,.25,.19,.056,.15,.019,.041,.0084,.018,.038,.019],[.59,1,.49,.088,.11,.04,.087,.046,.0049,.039,.0055,.021,.026,.0046,.0089,.0046],[.15,.62,1,.083,.62,.6,.39,.21,.098,.041,.015,.0077,.0051,.003,.0029,.0019],[1,.016,.19,.0055,.31,.0064,.2,.003,.13,.0058,.08,.012,.027,.0098,.027,.0066],[1,.079,.0075,.0012,.0011,56e-5,64e-5,5e-4,37e-5,41e-5,24e-5,12e-5,16e-5,12e-5,13e-5,72e-6],[1,.34,.063,.0044,.0016,.0016,.0012,.0012,84e-5,78e-5,67e-5,59e-5,37e-5,59e-5,38e-5,49e-5],[1,.01,.14,.0021,.14,.0014,.032,46e-5,.033,45e-5,.012,57e-5,.012,42e-5,.0065,28e-5],[1,.01,.39,.016,.37,.0076,.17,.0041,.08,.0024,.057,.0026,.026,.0022,.026,.0023],[1,.018,.14,.0071,.082,.0064,.039,.0041,.0026,.0045,.01,91e-5,.0039,.0034,.0027,.004],[.95,1,.42,.17,.14,.02,.064,.011,.099,.0026,.055,.0099,.028,.0066,.023,.0075],[1,.013,.0063,.0029,.002,.0012,85e-5,59e-5,79e-5,93e-5,46e-5,43e-5,22e-5,51e-5,53e-5,98e-5],[1,.0077,.082,.0035,.0027,.002,.0014,.0013,.0011,96e-5,95e-5,75e-5,88e-5,7e-4,66e-5,66e-5],[1,.015,.23,.0042,.073,.01,.076,.006,.066,.0051,.044,.0067,.032,.0051,.037,.0076],[1,.22,.28,.14,.066,.062,.087,.071,.037,.045,.052,.027,.029,.038,.031,.025],[1,.063,.021,.0066,.0062,.0029,.0053,.0017,.0017,.0016,.0022,.0012,.0016,9e-4,78e-5,94e-5],[1,.38,.16,.034,.097,.023,.014,.011,.018,.0052,.0077,.0062,.0038,.0026,.0029,.0052],[.19,.09,.44,.49,1,.64,.13,.51,.22,.06,.2,.19,.12,.1,.11,.066],[1,.47,.45,.044,.14,.0042,.077,.0033,.13,.0031,.067,32e-5,.018,.0015,.043,.0022],[1,.4,.22,.047,.047,.045,.033,.022,.016,.013,.0082,.0022,.0043,.0033,5e-4,.0018],[.76,.55,1,.14,.28,.18,.03,.12,.13,.079,.078,.087,.03,.072,.11,.016],[1,.011,.006,.0044,.0033,.0029,.0027,.0033,.12,.0027,.15,.0048,.0028,.0021,.0018,.0015],[1,.022,.013,.0097,.01,.0071,.0053,.0051,.004,.004,.0045,.0034,.0028,.0033,.0025,.0013],[1,.72,.54,.27,.18,.11,.087,.064,.042,.026,.021,.014,.011,.0087,.0081,.0067],[1,.66,.19,.025,.093,.086,.02,.035,.029,.0093,.013,.0045,.0057,.0073,.0032,.0046],[1,.016,.0067,.0054,.11,.0039,.09,.0037,.0029,.003,.015,.0016,.0085,.0014,98e-5,89e-5],[1,.11,.16,.023,.12,.06,.11,.0015,.097,.049,.0098,81e-5,.008,.013,.012,.0048],[1,.22,.47,.26,.14,.21,.057,.083,.027,.05,.027,.0034,.033,.018,.023,.027],[1,.48,.069,.058,.017,.019,.011,.0034,.004,.0055,.006,.0018,.0086,.01,.0087,.01],[1,.42,.096,.18,.012,.015,.0043,.0049,.0013,.0029,.0015,.0021,.0011,.0018,58e-5,.0012],[1,.23,.18,.073,.11,.052,.027,.021,.035,.021,.061,.015,.05,.036,.061,.012],[.81,.018,1,.011,.11,.0043,.35,.0023,.027,.001,.11,.0032,.0055,.0019,.032,.0013],[.4,.88,.42,.27,1,.062,.26,.065,.69,.34,.19,.039,.045,.32,.11,.052],[1,.41,.26,.033,.13,.0062,.013,.0019,.016,.0018,.069,.0017,.036,.0028,.058,.0019],[1,.11,.13,.035,.051,.039,.039,.029,.037,.054,.0041,.016,.0087,.0087,.0071,.022],[.9,1,.62,.1,.039,.013,.0031,7e-4,33e-5,49e-5,31e-5,28e-5,75e-6,5e-5,41e-5,84e-6],[.78,1,.57,.61,.41,.55,.37,.44,.32,.36,.27,.14,.17,.16,.16,.15],[1,.39,.69,.17,.51,.39,.26,.17,.28,.17,.26,.1,.1,.072,.026,.13],[.81,1,.6,.21,.37,.25,.16,.28,.19,.037,.11,.051,.042,.079,.03,.033],[.066,.3,.85,1,.88,.2,.39,.074,.53,.15,.11,.23,.14,.17,.032,.23],[.22,.64,1,.5,.2,.42,.23,.19,.37,.29,.19,.12,.031,.049,.14,.18],[1,.013,.0078,.0053,.0044,.0033,.025,.0028,.027,.002,.0064,.0017,.0038,.0015,88e-5,.0013],[.52,.79,.8,1,.75,.48,.17,.26,.33,.32,.32,.41,.33,.31,.22,.22],[1,.41,.17,.12,.049,.14,.11,.013,.02,.036,.025,.032,.041,.02,.01,.013],[.56,.65,1,.43,.26,.66,.46,.39,.3,.18,.074,.1,.1,.13,.1,.14],[.17,.21,.12,.085,.2,.47,1,.25,.14,.096,.066,.056,.049,.042,.039,.18],[.74,.83,.0056,.0079,.47,.0052,.0037,.15,1,.0071,.29,.21,.0051,.022,.78,.0029],[.46,1,.013,.18,.092,.0034,.13,.21,.0064,.19,.0014,.0023,.0073,.15,71e-5,.11],[.15,.0017,.22,.0012,1,.0027,.12,29e-5,.25,8e-4,.019,.0018,.17,.0023,.033,.0011],[1,.32,.24,.17,.12,.13,.085,.074,.071,.065,.057,.056,.051,.045,.045,.043],[1,.011,.0051,.004,.0016,.0033,.0027,.0023,.0026,.0014,.0014,.002,.0019,.0011,89e-5,.0013],[1,.33,.19,.14,.13,.1,.078,.06,.052,.056,.058,.052,.05,.044,.035,.03],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[.29,.1,.37,.029,.091,.15,.21,.51,.35,.14,.2,1,.032,.16,.16,.29],[1,.025,.12,.012,.019,.0025,.0061,.0087,.0062,.0012,.0034,.0031,.0048,.0049,.0055,.0019],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[.0023,.002,.0036,.0011,.0017,.0018,.0019,.0022,.0046,.0029,.0039,.0046,.0063,.017,.016,1],[.052,.14,1,.014,.034,.012,.066,.091,.036,.031,.046,.0073,.021,.039,.022,.024],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[.57,.96,.68,.64,1,.46,.7,.22,.47,.51,.82,.85,.49,.56,.27,.24],[1,.42,.65,.73,.39,.17,.15,.072,.49,.77,.79,.23,.26,.15,.37,.38]],D=[[0,1.16,.157,.252],[0,1.58,.109,.276],[0,1.56,.117,.136],[.0232,1.49,.111,.276],[0,.766,.0805,.0666],[0,1.35,.0868,.0434],[0,1.65,.134,.136],[0,1.6,.129,.0434],[0,1.09,.0605,.252],[0,.813,.0542,.159],[0,.766,.0224,.5],[0,1.7,.217,.252],[0,.441,.0544,.0201],[0,.58,.0511,.0201],[0,.882,.0786,.5],[0,1.56,.0909,.415],[0,.975,.721,.0666],[0,.0697,.94,.0898],[0,.139,.602,.0434],[.0232,.0929,.802,.299],[.0464,.627,.747,.136],[.0464,.65,.492,.0898],[.0464,.488,.715,.0201],[.0232,.0929,.92,.159],[0,1.6,.123,.0898],[0,1.18,.052,.0434],[0,1.07,.00299,.0201],[0,1.07,.054,.0201],[0,.65,.051,.0201],[0,.163,.789,.136],[0,.139,.758,.136],[0,2,.233,.0201],[0,1.7,.15,.252],[0,1.42,.0763,.0201],[0,1.6,.124,.0434],[0,1.56,.132,.0898],[0,1.32,.0756,.136],[0,.766,.128,.0201],[.0232,.418,.0556,.0201],[.0464,1.72,.0445,.0434],[.0464,2,.315,.276],[.0464,.255,.77,.159],[.116,.488,.859,.113],[.0464,.163,.855,.252],[.0929,.673,.651,.5],[0,.372,.0391,.0201],[0,.789,.0757,.5],[0,1.58,.12,.5],[.0464,.627,.682,.5],[.163,.488,.944,.5],[.0697,.0929,.962,.5],[.0929,.743,.979,.5],[.186,2,.892,.276],[.0464,.0929,.868,.113],[.0697,.279,.255,.368],[.0232,.395,.035,.0201],[.139,.186,.962,.136],[.0464,.72,.444,.0434],[0,1.14,.334,.136],[0,.0929,.687,.0666],[.0232,.627,.828,.485],[.0232,2,.861,.136],[.0929,.186,.838,.136],[.0464,.186,.556,.113],[.0232,.0464,.965,.0898],[.0232,.186,.661,.0898],[.0232,2,.871,.0201],[0,2,.67,.0201],[.0232,.0464,.992,.136],[.0232,.0929,1,.0434],[0,2,.658,.0201],[.0464,.116,.759,.0434],[.0232,.116,.576,.0201],[.0464,.139,.726,.0201],[.0232,.255,.519,.136],[0,.0464,.712,.0898],[.0929,.163,.378,.113],[.0232,.325,.174,.0201],[.116,.163,.987,.159],[.0232,.302,.516,.0201],[.0232,2,.814,.0201],[0,.139,.683,.0201],[.0464,2,.284,.159],[0,.139,.769,.0201],[0,.627,.503,.0201],[0,1.16,.646,.229],[.0232,1.72,.445,.5],[0,.0464,.905,.0434],[0,.627,.632,.5],[.441,2,.217,.461],[.0464,.975,.704,.252],[0,.511,.66,.5],[.0929,2.02,.0269,.5],[.186,1.6,.103,.5],[.116,.998,.626,.5],[.418,.65,.681,.5],[.0232,1.6,.199,.136],[.418,.441,.703,.5],[.0232,.998,.0314,.461],[.0929,1.72,.123,.5],[0,1.44,.241,.5],[.534,2,.584,.5],[.0232,2,.885,.5],[.0929,1.51,.327,.5],[.0232,1.86,.238,.5],[0,1.14,.0565,.252],[0,.604,.0565,.5],[0,.464,.062,.5],[0,.488,.0529,.0201],[0,.0232,.998,.0434],[.0464,.882,.532,.252],[0,.279,.678,.0898],[0,1.42,.0644,.5],[0,.116,.00112,.0201],[0,.488,.051,.0201],[3,2,0,.0201],[0,.975,.0521,.368],[0,.279,.0387,.0201],[0,.836,.0509,.0201],[.627,1.88,4.54e-8,.0201],[.0697,.163,.0072,.0201],[.116,.255,.328,.299],[1.44,2,.976,.5],[.0232,.139,.0105,.5],[0,.209,.917,.5],[.906,2,.654,.5],[.279,2,.999,.5],[0,.302,.0269,.0201]],w=[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1,!0,!0,!1,!1,!0];function P(){return 2*Math.random()*Math.PI-Math.PI}var x=new Array(128);function N(e,t){if(x[t])return x[t];var a=function(){var e=[0],t=[0];return M[arguments.length>0&&void 0!==arguments[0]?arguments[0]:0].forEach((function(a){var i=P();e.push(a*Math.cos(i)),t.push(a*Math.sin(i))})),[new Float32Array(e),new Float32Array(t)]}(t),i=e.createPeriodicWave(a[0],a[1]);return x[t]=i,i}function O(e){var t=this,a=this.createBaseNote(e,!1,!0,!1,!0);if(a.isGainValueZero)return null;var i,n=a.oscillator,s=a.gainNode,r=a.stopGainNode,o=!1,u=!1;switch(this.settings.soundQuality){case 0:switch(1e3*this.channels[a.channel][0]||e.instrument){case 1e3:case 6:case 15:case 24:case 26:case 46:case 50:case 51:case 52:case 53:case 54:case 82:case 85:case 86:n.type="sine",s.gain.value*=1.5;break;case 2e3:case 4:case 12:case 13:case 16:case 19:case 20:case 32:case 34:case 45:case 48:case 49:case 55:case 56:case 57:case 61:case 62:case 63:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 84:n.type="square",s.gain.value*=.8;break;case 3e3:case 0:case 1:case 2:case 3:case 7:case 17:case 18:case 21:case 22:case 23:case 27:case 28:case 29:case 30:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 47:case 59:case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 87:n.type="sawtooth";break;case 4e3:case 8:case 9:case 10:case 11:case 14:case 25:case 31:case 33:case 35:case 58:case 60:case 83:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:n.type="triangle",s.gain.value*=1.5;break;default:n.type="square"}break;case 1:n.setPeriodicWave(N(this.context,e.instrument))}switch(("sine"==n.type||"triangle"==n.type)&&!o&&a.stop-a.start>.01&&(u=!0),this.settings.soundQuality){case 0:switch(this.channels[a.channel][1]/10||e.instrument){case.2:case 12:case 13:case 45:case 55:o=!0,s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,a.start),s.gain.linearRampToValueAtTime(0,a.start+.2),this.stopAudioNode(n,a.start+.2,r);break;case.3:case 0:case 1:case 2:case 3:case 6:case 9:case 11:case 14:case 15:case 32:case 36:case 37:case 46:case 47:s.gain.value*=1.1;var c=(128-e.pitch)/128;s.gain.setValueAtTime(s.gain.value,a.start),s.gain.linearRampToValueAtTime(.85*s.gain.value,a.start+c*c/8),s.gain.linearRampToValueAtTime(.8*s.gain.value,a.start+c*c/4),s.gain.setTargetAtTime(0,a.start+c*c/4,5*c*c),this.stopAudioNode(n,a.stop,r,u);break;case.4:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 34:s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,a.start),s.gain.linearRampToValueAtTime(0,a.start+1+4*a.velocity),this.stopAudioNode(n,a.stop,r,u);break;case.5:case 4:case 5:case 7:case 8:case 10:case 33:case 35:s.gain.value*=1,s.gain.setValueAtTime(s.gain.value,a.start),s.gain.linearRampToValueAtTime(.95*s.gain.value,a.start+.1),s.gain.setValueAtTime(.95*s.gain.value,a.start+.1),s.gain.linearRampToValueAtTime(0,a.start+2+10*a.velocity),this.stopAudioNode(n,a.stop,r,u);break;case 119:if(s.gain.value=0,this.stopAudioNode(n,a.stop,r,u),(i=this.createBaseNote(e,!0,!0)).isGainValueZero)break;i.oscillator.playbackRate.setValueAtTime((e.pitch+1)/128,a.start),i.gainNode.gain.setValueAtTime(0,a.start),i.gainNode.gain.linearRampToValueAtTime(1.3,a.start+2),this.stopAudioNode(i.oscillator,a.stop,i.stopGainNode);break;default:s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,a.start),this.stopAudioNode(n,a.stop,r,u)}break;case 1:var l=D[e.instrument],m=l[0],h=l[1],p=l[2],T=l[3],f=1.2*s.gain.value,g=w[e.instrument],v=Math.max(m,.001);if(s.gain.setValueAtTime(0,a.start),s.gain.setTargetAtTime(f,a.start,v/3),g){var d=h*((128-e.pitch)/64);s.gain.setTargetAtTime(0,a.start+v,d/2)}else s.gain.setTargetAtTime(f*p,a.start+v,h/2);var y=Math.min(T,.25);s.gain.setTargetAtTime(0,a.stop,y/3),this.stopAudioNode(n,a.stop+y,r,u)}return function(){t.stopAudioNode(n,0,r,!0),i&&i.oscillator&&t.stopAudioNode(i.oscillator,0,i.stopGainNode,!0)}}function S(e){var t=this,a=this.createBaseNote(e,!0,!1);if(a.isGainValueZero)return null;var i=a.oscillator,n=a.gainNode,s=a.stopGainNode,r=a.start,o=this.createBaseNote(e,!1,!1,!0),u=o.oscillator,c=o.gainNode,l=o.stopGainNode,m=e.nextSameNoteOnInterval;r<this.context.currentTime&&(r=this.context.currentTime);var h=0,p=0;switch(e.pitch){case 35:case 36:n.gain.value=.6,i.playbackRate.value=.02,h=.07,c.gain.value=1.1,u.frequency.setValueAtTime(120,r),u.frequency.linearRampToValueAtTime(50,r+.07),p=.07;break;case 38:case 40:i.playbackRate.value=.7,h=.05,c.gain.setValueAtTime(.8,r),c.gain.linearRampToValueAtTime(0,r+.05),u.frequency.setValueAtTime(300,r),u.frequency.linearRampToValueAtTime(200,r+.05),p=.05;break;case 41:case 43:case 45:case 47:case 48:case 50:i.playbackRate.value=.01,h=.1,u.type="square",c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(.01,r+.1),u.frequency.setValueAtTime(150+20*(e.pitch-40),r),u.frequency.linearRampToValueAtTime(50+20*(e.pitch-40),r+.1),p=.1;break;case 42:case 44:i.playbackRate.value=1.5,h=.02,p=0;break;case 46:i.playbackRate.value=1.5,h=.3,n.gain.setValueAtTime(.9,r),n.gain.linearRampToValueAtTime(0,r+.3),p=0;break;case 49:case 52:case 53:case 55:case 57:i.playbackRate.value=1.2,h=.5,n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,r+.5),p=0;break;case 51:i.playbackRate.value=1.1,h=.4,n.gain.setValueAtTime(.8,r),n.gain.linearRampToValueAtTime(0,r+.4),p=0;break;case 59:i.playbackRate.value=1.8,h=.3,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(0,r+.3),p=0;break;case 60:case 61:i.playbackRate.value=.03,h=.03,c.gain.setValueAtTime(.8,r),c.gain.linearRampToValueAtTime(0,r+.1),u.frequency.setValueAtTime(400-40*(e.pitch-60),r),u.frequency.linearRampToValueAtTime(450-40*(e.pitch-60),r+.1),p=.1;break;case 62:i.playbackRate.value=.03,h=.03,c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(0,r+.03),u.frequency.setValueAtTime(200,r),u.frequency.linearRampToValueAtTime(250,r+.03),p=.03;break;case 63:case 64:i.playbackRate.value=.03,h=.03,c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(0,r+.1),u.frequency.setValueAtTime(200-30*(e.pitch-63),r),u.frequency.linearRampToValueAtTime(250-30*(e.pitch-63),r+.1),p=.1;break;case 56:case 75:i.playbackRate.value=.01,h=.1,c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(0,r+.1),u.frequency.setValueAtTime(1e3+48*(e.pitch-56),r),p=.1;break;case 80:i.playbackRate.value=5,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(0,r+.2),h=.05,u.type="triangle",c.gain.setValueAtTime(.7,r),c.gain.linearRampToValueAtTime(0,r+.2),u.frequency.setValueAtTime(6e3,r),p=.05;break;case 81:i.playbackRate.value=5,n.gain.setValueAtTime(.9,r),n.gain.linearRampToValueAtTime(0,r+.5),h=.5,u.type="triangle",c.gain.setValueAtTime(.8,r),c.gain.linearRampToValueAtTime(0,r+.3),u.frequency.setValueAtTime(6e3,r),p=.3;break;case 37:i.playbackRate.value=.26,n.gain.setValueAtTime(1.5,r),n.gain.linearRampToValueAtTime(0,r+.041),h=.041,u.frequency.setValueAtTime(330,r),u.frequency.linearRampToValueAtTime(120,r+.02),c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(0,r+.02),p=.02;break;case 39:i.playbackRate.value=.5,n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(0,r+.01),n.gain.setValueAtTime(1.3,r+.0101),n.gain.linearRampToValueAtTime(0,r+.02),n.gain.setValueAtTime(1.3,r+.0201),n.gain.linearRampToValueAtTime(0,r+.09),h=.09,u.type="triangle",u.frequency.setValueAtTime(180,r),c.gain.setValueAtTime(.8,r),c.gain.linearRampToValueAtTime(0,r+.01),c.gain.setValueAtTime(.8,r+.0101),c.gain.linearRampToValueAtTime(0,r+.02),c.gain.setValueAtTime(.8,r+.0201),c.gain.linearRampToValueAtTime(0,r+.03),p=.11;break;case 54:i.playbackRate.setValueAtTime(1,r);var T=54==e.pitch?1:.4,f=54==e.pitch?.01:0;n.gain.setValueAtTime(1*T/2,r),n.gain.linearRampToValueAtTime(1*T,r+f),n.gain.setTargetAtTime(0,r+f,.05),h=.3,u.frequency.setValueAtTime(54==e.pitch?6e3:495,r),T=54==e.pitch?1:2,c.gain.setValueAtTime(1*T/2,r),c.gain.linearRampToValueAtTime(1*T,r+f),c.gain.setTargetAtTime(0,r+f,.05),p=.3;break;case 58:i.playbackRate.setValueAtTime(.6,r),i.playbackRate.linearRampToValueAtTime(1,r+.8);var g=40;n.gain.setValueAtTime(1.5,r),c.gain.setValueAtTime(.5,r);for(var v=0;v<g;v++)n.gain.linearRampToValueAtTime(.1*(g-v)/g,r+v/g*.8),n.gain.linearRampToValueAtTime(1.5*(g-(v+1))/g,r+(v+.99)/g*.8),c.gain.linearRampToValueAtTime(.025*(g-v)/g,r+v/g*.8),c.gain.linearRampToValueAtTime(.25*(g-(v+1))/g,r+(v+.99)/g*.8);n.gain.linearRampToValueAtTime(0,r+.8),c.gain.linearRampToValueAtTime(0,r+.8),h=.8,u.type="triangle",u.frequency.setValueAtTime(1e3,r),p=.8;break;case 65:case 66:var d=65==e.pitch?.22:.25;i.playbackRate.setValueAtTime(65==e.pitch?.25:.22,r),i.playbackRate.linearRampToValueAtTime(65==e.pitch?.2:.18,r+d),n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(.2,r+d/3.5),n.gain.linearRampToValueAtTime(0,r+d),h=d,u.type="triangle",u.frequency.setValueAtTime(65==e.pitch?203.3:145.52,r),u.frequency.linearRampToValueAtTime(65==e.pitch?190:136,r+.1),c.gain.setValueAtTime(3.2,r),c.gain.setTargetAtTime(0,r,.08),p=1;break;case 67:case 68:i.playbackRate.value=1,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(.1,r+.02),n.gain.linearRampToValueAtTime(0,r+.08),h=.08,u.type="triangle",u.frequency.setValueAtTime(67==e.pitch?1430:1055,r),c.gain.setValueAtTime(2,r),c.gain.setTargetAtTime(0,r,.06),p=.75;break;case 69:i.playbackRate.value=1,n.gain.setValueAtTime(.3,r),n.gain.linearRampToValueAtTime(.8,r+.03),n.gain.linearRampToValueAtTime(0,r+.08),h=.08,c.gain.value=0,p=0;break;case 70:i.playbackRate.value=1,n.gain.setValueAtTime(1.2,r),n.gain.linearRampToValueAtTime(0,r+.06),h=.06,c.gain.value=0,p=0;break;case 71:case 72:n.gain.value=0,h=0;var y=71==e.pitch?.07:.4;u.type="triangle",u.frequency.setValueAtTime(71==e.pitch?2408:2105,r),c.gain.setValueAtTime(0,r);for(var b=0;b<74*y;b++)c.gain.linearRampToValueAtTime(2.5,r+(b+.2)/75),c.gain.linearRampToValueAtTime(.5,r+(b+.9)/75);c.gain.linearRampToValueAtTime(0,r+y),p=y;break;case 73:case 74:var A=73==e.pitch?.05:.35;i.playbackRate.setValueAtTime((e.pitch,.2),r),i.playbackRate.linearRampToValueAtTime(73==e.pitch?.7:.5,r+A),n.gain.value=.2;for(var V=0;V<100*A;V++)n.gain.setValueAtTime(.4,r+V/100),n.gain.setValueAtTime(.9,r+(V+.7)/100);h=A,c.gain.value=0,p=0;break;case 76:case 77:i.playbackRate.value=.1,n.gain.setValueAtTime(1.2,r),n.gain.linearRampToValueAtTime(0,r+.015),h=.015,u.frequency.setValueAtTime(76==e.pitch?800:600,r),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(3,r+.005),c.gain.setTargetAtTime(0,r+.005,.02),p=.2;break;case 78:case 79:n.gain.value=0,h=0;var k=.18,I=78==e.pitch?750:270;u.frequency.setValueAtTime(I,r),u.frequency.linearRampToValueAtTime(I,r+.06),78==e.pitch&&u.frequency.linearRampToValueAtTime(.9*I,r+k),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(1.5,r+.005),c.gain.linearRampToValueAtTime(.5,r+.02),c.gain.linearRampToValueAtTime(3,r+.04),c.gain.linearRampToValueAtTime(2,r+.135),c.gain.linearRampToValueAtTime(0,r+k),p=k;break;case 27:i.playbackRate.value=1,n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,r+.002),h=.002,u.frequency.setValueAtTime(1500,r),u.frequency.linearRampToValueAtTime(280,r+.015),u.frequency.linearRampToValueAtTime(0,r+.07),c.gain.setValueAtTime(1.9,r),c.gain.linearRampToValueAtTime(0,r+.07),p=.07;break;case 28:i.playbackRate.value=1,n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(0,r+.01),n.gain.setValueAtTime(1.1,r+.0101),n.gain.linearRampToValueAtTime(0,r+.02),n.gain.setValueAtTime(.9,r+.0201),n.gain.setTargetAtTime(0,r+.0201,.03),h=.2,c.gain.value=0,p=0;break;case 29:case 30:var R=29==e.pitch?.05:.07,M=29==e.pitch?.06:.09,D=29==e.pitch?.07:.11,w=29==e.pitch?.1:.15,P=29==e.pitch?.25:.4,x=29==e.pitch?.1:.06,N=29==e.pitch?.3:.2,O=29==e.pitch?.18:.12;i.playbackRate.setValueAtTime(x,r),i.playbackRate.linearRampToValueAtTime(N,r+R),i.playbackRate.linearRampToValueAtTime(0,r+M),i.playbackRate.linearRampToValueAtTime(N,r+D),i.playbackRate.linearRampToValueAtTime(O,r+w),i.playbackRate.linearRampToValueAtTime(0,r+P),n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(.4,r+R),n.gain.linearRampToValueAtTime(.1,r+D),n.gain.linearRampToValueAtTime(.3,r+w),n.gain.linearRampToValueAtTime(0,r+P),h=P;var S=29==e.pitch?500:400,W=29==e.pitch?1950:1200,L=29==e.pitch?430:250;u.frequency.setValueAtTime(S,r),u.frequency.linearRampToValueAtTime(W,r+R),u.frequency.linearRampToValueAtTime(0,r+M),u.frequency.linearRampToValueAtTime(W,r+D),u.frequency.linearRampToValueAtTime(L,r+w),u.frequency.linearRampToValueAtTime(0,r+P),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(.7,r+R),c.gain.linearRampToValueAtTime(.2,r+D),c.gain.linearRampToValueAtTime(.6,r+w),c.gain.linearRampToValueAtTime(0,r+P),p=P;break;case 31:i.playbackRate.setValueAtTime(.4,r),i.playbackRate.linearRampToValueAtTime(.5,r+.015),n.gain.setValueAtTime(1.2,r),n.gain.setTargetAtTime(0,r,.035),h=.3,u.frequency.setValueAtTime(3140,r),c.gain.setValueAtTime(1.2,r),c.gain.setTargetAtTime(0,r,.012),p=.3;break;case 32:n.gain.value=0,h=0,u.type="square",u.frequency.setValueAtTime(333,r),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(4,r+.0016),c.gain.linearRampToValueAtTime(0,r+.0032),p=.0032;break;case 33:case 34:i.playbackRate.setValueAtTime(.17,r),i.playbackRate.linearRampToValueAtTime(.22,r+.01),n.gain.setValueAtTime(1.5,r),n.gain.setTargetAtTime(0,r,.015),h=.3,34==e.pitch?(u.frequency.setValueAtTime(2040,r),c.gain.setValueAtTime(1,r),c.gain.setTargetAtTime(0,r,.12),p=1.1):(c.gain.value=0,p=0);break;case 82:i.playbackRate.value=1,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(1,r+.02),n.gain.linearRampToValueAtTime(0,r+.07),h=.07,c.gain.value=0,p=0;break;case 83:i.playbackRate.value=1,n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(1.2,r+.015),n.gain.setTargetAtTime(0,r+.015,.06),h=.5,u.type="triangle",u.frequency.setValueAtTime(2709,r),u.frequency.linearRampToValueAtTime(2657,r+.3),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(.7,r+.025),c.gain.setTargetAtTime(0,r+.025,.07),p=.5;break;case 84:i.playbackRate.value=1;for(var E=0;E<28;E++)n.gain.setValueAtTime(.1,r+E/24*.45),n.gain.setTargetAtTime(0,r+E/24*.45,.01),u.frequency.setValueAtTime(1380*(1+E/24),r+E/24*.45),c.gain.setValueAtTime(1*(.2+E/24),r+E/24*.45),c.gain.setTargetAtTime(0,r+E/24*.45,27==E?.2:.01);h=.5,p=1.5;break;case 85:i.playbackRate.setValueAtTime(.35,r),n.gain.setValueAtTime(1.3,r),n.gain.setTargetAtTime(0,r,.01),h=.1,u.frequency.setValueAtTime(1730,r),c.gain.setValueAtTime(.5,r),c.gain.setTargetAtTime(0,r,.01),p=.1;break;case 86:case 87:i.playbackRate.setValueAtTime(.02,r),i.playbackRate.linearRampToValueAtTime(.015,r+.5),n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(2,r+.005),n.gain.setTargetAtTime(0,r+.005,86==e.pitch?.03:.06),h=.5,u.frequency.setValueAtTime(88,r),u.frequency.linearRampToValueAtTime(86,r+.3),c.gain.setValueAtTime(2.5,r),c.gain.setTargetAtTime(0,r,86==e.pitch?.1:.3),p=86==e.pitch?.5:1.5;break;default:i.playbackRate.value=e.pitch/69*2,h=.05,p=0}return this.settings.isSameDrumSoundOverlap||-1==m||(h>m&&(h=m),p>m&&(p=m)),this.stopAudioNode(i,r+h,s),this.stopAudioNode(u,r+p,l),e.drumStopTime=e.startTime+(h>=p?h:p),function(){t.stopAudioNode(i,0,s,!0),t.stopAudioNode(u,0,l,!0)}}function W(e,t,a,i){var n=t-.005,s=t;t<=this.context.currentTime&&(i?(n=this.context.currentTime,s=this.context.currentTime+.005):s=this.context.currentTime);try{i?(e.stop(s),a.gain.cancelScheduledValues(0),a.gain.setValueAtTime(1,n),a.gain.linearRampToValueAtTime(0,s)):e.stop(s)}catch(e){a.gain.cancelScheduledValues(0),i?(a.gain.setValueAtTime(1,n),a.gain.linearRampToValueAtTime(0,s)):a.gain.setValueAtTime(0,s)}}function L(e){(e.note||e.rootTimeout||e.pan||this.trigger.isNoteTrigger)&&this.states.stopFuncs.push(e)}function E(e,t){("note"==e||"rootTimeout"==e||"pan"==e||this.trigger.isNoteTrigger)&&this.states.stopFuncs.some((function(a,i,n){if(a[e]==t)return y.delete(n,i),!0}))}function q(e){var t=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].timing)return this.tempoTrack[this.tempoTrack.length-1].time;for(var a=0,i=this.tempoTrack.length-1;;){t=Math.floor(a+(i-a)/2);var n=this.tempoTrack[t].timing;if(e<n)i=t-1;else{if(!(e>n))break;a=t+1}if(a>i){e<n&&t--;break}}}var s=0,r=0,o=120;if(t>=0){var u=this.tempoTrack[t];s=u.time,r=u.timing,o=u.value}return s+=60/o/this.settings.resolution*(e-r)}function B(e){var t=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].time)return this.tempoTrack[this.tempoTrack.length-1].timing;for(var a=0,i=this.tempoTrack.length-1;;){t=Math.floor(a+(i-a)/2);var n=this.tempoTrack[t].time;if(e<n)i=t-1;else{if(!(e>n))break;a=t+1}if(a>i){e<n&&t--;break}}}var s=0,r=0,o=120;if(t>=0){var u=this.tempoTrack[t];s=u.time,r=u.timing,o=u.value}return r+=(e-s)/(60/o/this.settings.resolution)}function C(e){var t=e.smf,a=4,i={};i.size=b.getInt(t,4,8),i.format=t[9],i.trackcount=b.getInt(t,10,12),i.timemanage=t[12],i.resolution=b.getInt(t,12,14),a+=4+i.size;for(var n=[],s=this.settings.isWebMIDI||this.settings.preserveSmfData?17:16,r=0;r<s;r++){var o={};n.push(o),o.indices=[],o.indicesLength=0,o.indicesHead=-1,o.indicesFoot=0,o.indicesCur=0,o.indicesPre=0,o.notes=[]}return e.p=a,e.header=i,e.channels=n,e}function F(e){for(var t=e.smf,a=e.p,i=e.header,n=e.channels,s=[],r=[],o=0,u=0;u<i.trackcount;u++){if(77!=t[a]||84!=t[a+1]||114!=t[a+2]||107!=t[a+3])return"Irregular SMF.";var c=(a+=4)+4+b.getInt(t,a,a+4);a+=4;for(var l=0,m=120,h=0,p=0,T=1,f=void 0;a<c;){if(null!=T){var g=b.variableLengthToInt(t,a,a+5);l+=f=g[0],a+=g[1]}var v=a;switch(t[a]>>4){case 8:case 9:case 10:case 11:case 14:var d=n[15&(T=t[a])];b.chIndicesInsert(this,d,l,a,3),a+=3;break;case 12:case 13:var y=n[15&(T=t[a])];b.chIndicesInsert(this,y,l,a,2),a+=2;break;case 15:switch(t[a]){case 240:case 247:var A=b.variableLengthToInt(t,a+1,a+1+4);if(A[0]>=7&&127==t[a+2]&&127==t[a+3]&&4==t[a+4]&&1==t[a+5])for(var V=0;V<16;V++){var k=n[V];b.chIndicesInsert(this,k,l,a,A[0])}a+=1+A[1]+A[0];break;case 241:case 243:a+=2;break;case 242:a+=3;break;case 246:case 248:case 250:case 251:case 252:case 254:a+=1;break;case 255:switch(t[a+1]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 32:case 84:break;case 47:l+=(this.settings.isSkipEnding?0:i.resolution)-f;break;case 81:for(var I=0;I<16;I++){var R=n[I];b.chIndicesInsert(this,R,l,a,6)}p+=60/m/i.resolution*(l-h),h=l,m=6e7/(65536*t[a+3]+256*t[a+4]+t[a+5]),s.push({timing:l,time:p,value:m});break;case 88:r.push({timing:l,value:[t[a+3],Math.pow(2,t[a+4])]})}var M=b.variableLengthToInt(t,a+2,a+2+4);a+=2+M[1]+M[0]}break;default:if(null==T)return"Irregular SMF. ("+a+" byte addr)";t[--a]=T,T=null}(this.settings.isWebMIDI||this.settings.preserveSmfData)&&null!=T&&b.chIndicesInsert(this,n[16],l,v,a-v)}!this.settings.isSkipEnding&&o<l&&(o=l);for(var D=0;D<n.length;D++)n[D].indicesCur=n[D].indicesHead,n[D].indicesPre=n[D].indicesHead}return e.p=a,e.tempoTrack=s,e.beatTrack=r,e.songLength=o,e}function G(t){for(var a,i,n,s=this,r=t.smf,o=t.header,u=t.channels,c=t.tempoTrack,l=t.songLength,m=-1,h=-1,p=g,T=g,f=0,v=0,d=0,b=0,A=function(t){var c=u[t],l=2,g=0,A=64,V=127,k=100,I=0,R=0,M=s.settings.initReverb,D=0,w=127,P=127,x=0,N=127;a=120,i=0,n=0;for(var O=[],S=c.indicesHead,W=c.indices,L=new Array(128),E=function(){var e=W[S],u=W[S+2],E=W[S+3],q=60/a/o.resolution*(e-i)+n,B=r[u]>>4;switch(B){case 8:case 9:if(9==B&&0!=r[u+2]){var C={start:e,stop:null,startTime:q,stopTime:null,pitch:r[u+1],pitchBend:[{timing:e,time:q,value:g}],pan:[{timing:e,time:q,value:A}],expression:[{timing:e,time:q,value:V*(N/127)}],velocity:r[u+2]/127*(k/127),modulation:[{timing:e,time:q,value:I}],holdBeforeStop:null,reverb:[{timing:e,time:q,value:M}],chorus:[{timing:e,time:q,value:D}],instrument:x,channel:t,nextSameNoteOnInterval:-1,drumStopTime:2},F=L[r[u+1]];F&&(F.nextSameNoteOnInterval=q-F.startTime),L[r[u+1]]=C,O.some((function(t,a){var i=c.notes[t];i.pitch==r[u+1]&&null==i.stop&&(i.stop=e,i.stopTime=q,y.delete(O,a))})),O.push(c.notes.length),c.notes.push(C),e<p&&(p=e,T=q)}else O.some((function(t,a){var i=c.notes[t];if(i.pitch==r[u+1]&&null==i.stop)return R>=s.settings.holdOnValue?null==i.holdBeforeStop&&(i.holdBeforeStop=[{timing:e,time:q,value:R}]):(i.stop=e,i.stopTime=q,y.delete(O,a)),e>f&&(f=e,v=q),!0}));break;case 10:case 13:break;case 11:switch(r[u+1]){case 1:I=r[u+2],O.forEach((function(t){c.notes[t].modulation.push({timing:e,time:q,value:I})}));break;case 6:0==w&&0==P&&(l=r[u+2])>24&&(l=24);break;case 7:k=r[u+2];break;case 10:A=r[u+2],O.forEach((function(t){c.notes[t].pan.push({timing:e,time:q,value:A})}));break;case 11:V=r[u+2],O.forEach((function(t){c.notes[t].expression.push({timing:e,time:q,value:V*(N/127)})}));break;case 64:if((R=r[u+2])<s.settings.holdOnValue)for(var G=O.length-1;G>=0;G--){var _=O[G],j=c.notes[_];null==j.stop&&null!=j.holdBeforeStop&&(j.stop=e,j.stopTime=q,y.delete(O,G))}break;case 91:M=r[u+2],O.forEach((function(t){c.notes[t].reverb.push({timing:e,time:q,value:M})}));break;case 93:D=r[u+2],O.forEach((function(t){c.notes[t].chorus.push({timing:e,time:q,value:D})}));break;case 98:r[u+2];break;case 99:r[u+2];break;case 100:w=r[u+2];break;case 101:P=r[u+2];break;case 111:-1==m&&(m=e,h=q)}break;case 12:x=r[u+1];break;case 14:g=(128*r[u+2]+r[u+1]-8192)/8192*l,O.forEach((function(t){c.notes[t].pitchBend.push({timing:e,time:q,value:g})}));break;case 15:switch(r[u]){case 240:case 247:if(127==r[u+1]&&127==r[u+2]&&4==r[u+3]&&1==r[u+4]){var z=r[u+6];z>127&&(z=127),N=z,O.forEach((function(t){c.notes[t].expression.push({timing:e,time:q,value:V*(N/127)})}))}break;case 255:if(81===r[u+1])n+=60/a/o.resolution*(e-i),i=e,a=6e7/(65536*r[u+3]+256*r[u+4]+r[u+5])}break;default:return{v:{v:"Error parseSMF. "}}}S=E,e>d&&(d=e,b=q)};-1!=S;){var q=E();if("object"===e(q))return q.v}c.nowNoteOnIdxAry=O,s.debug||delete c.indices},V=0;V<16;V++){var k=A(V);if("object"===e(k))return k.v}for(var I=0;I<16;I++){for(var R=u[I],M=R.nowNoteOnIdxAry,D=function(e){var t=R.notes[M[e]];if(null==t.stop){t.stop=f,t.stopTime=v;["pitchBend","pan","expression","modulation","reverb","chorus"].forEach((function(e){for(var a=t[e],i=a.length-1;i>=1;i--){a[i].timing>f&&y.delete(a,i)}})),y.delete(M,e)}},w=M.length-1;w>=0;w--)D(w);delete R.nowNoteOnIdxAry}this.settings.isSkipEnding&&(l=f),this.settings.isCC111&&-1!=h&&(l=d),c.push({timing:l,time:60/a/o.resolution*(l-i)+n,value:120});var P=[];if(this.settings.isWebMIDI||this.settings.preserveSmfData)for(var x=u[16],N=120,O=0,S=0,W=x.indicesHead,L=x.indices;-1!=W;){var E=L[W],q=L[W+1],B=L[W+2],C=L[W+3],F=60/N/o.resolution*(E-O)+S;if(255===r[B])if(81===r[B+1])S+=60/N/o.resolution*(E-O),O=E,N=6e7/(65536*r[B+3]+256*r[B+4]+r[B+5]);P.push({time:F,tick:E,smfPtr:B,smfPtrLen:q}),W=C}return t.songLength=l,t.cc111Tick=m,t.cc111Time=h,t.firstNoteOnTiming=p,t.firstNoteOnTime=T,t.lastNoteOffTiming=f,t.lastNoteOffTime=v,t.lastEventTiming=d,t.lastEventTime=b,(this.settings.isWebMIDI||this.settings.preserveSmfData)&&(t.messages=P,t.smfData=new Uint8Array(r)),t}function _(e){if(this.debug){console.log(e);var t=f.now()}var a=new Uint8Array(e);if(77!=a[0]||84!=a[1]||104!=a[2]||100!=a[3])return"Not Sandard MIDI File.";var i={};if(i.smf=a,C.call(this,i),this.debug)var n=f.now();if(F.call(this,i),this.debug)var s=f.now();G.call(this,i);var r={};if(r.header=i.header,r.tempoTrack=i.tempoTrack,r.beatTrack=i.beatTrack,r.channels=i.channels,r.songLength=i.songLength,r.cc111Tick=i.cc111Tick,r.cc111Time=i.cc111Time,r.firstNoteOnTiming=i.firstNoteOnTiming,r.firstNoteOnTime=i.firstNoteOnTime,r.lastNoteOffTiming=i.lastNoteOffTiming,r.lastNoteOffTime=i.lastNoteOffTime,r.lastEventTiming=i.lastEventTiming,r.lastEventTime=i.lastEventTime,(this.settings.isWebMIDI||this.settings.preserveSmfData)&&(r.messages=i.messages,r.smfData=new Uint8Array(a)),this.debug){var o=f.now();console.log("parseSMF time",o-t),console.log("parseSMF(0/2) time",n-t),console.log("parseSMF(1/2) time",s-n),console.log("parseSMF(2/2) time",o-s),console.log(r)}return r}function j(){var e=this;if(navigator.requestMIDIAccess){var t=this.settings.WebMIDIPortSysEx,a=function(a){var i,n=a.outputs;return e.settings.WebMIDIPortOutputs=n,-1==e.settings.WebMIDIPort?e.settings.WebMIDIPortOutputs.forEach((function(e){i||(i=e)})):i=e.settings.WebMIDIPortOutputs.get(e.settings.WebMIDIPort),e.settings.WebMIDIPortOutput=i,e.settings.WebMIDIPortSysEx=t,i&&(i.open(),e.initStatus()),n};navigator.requestMIDIAccess({sysex:t}).then(a).catch((function e(i){console.log(i),t&&(t=!1,navigator.requestMIDIAccess({sysex:t}).then(a).catch(e))})),window.addEventListener("unload",(function(){for(var t=0;t<16;t++){e.settings.WebMIDIPortOutput.send([176+t,120,0]);for(var a=0;a<128;a++)e.settings.WebMIDIPortOutput.send([128+t,a,0])}}))}}return function(){function e(a){t(this,e),l.call(this,a)}return i(e,[{key:"init",value:function(e){return T.call(this,e)}},{key:"parseSMF",value:function(e){return _.call(this,e)}},{key:"setData",value:function(e){return v.call(this,e)}},{key:"play",value:function(e){return V.call(this,e)}},{key:"pause",value:function(e){return k.call(this,e)}},{key:"stop",value:function(e){return k.call(this,e)}},{key:"initStatus",value:function(e,t){return d.call(this,e,t)}},{key:"setStartTime",value:function(e){this.states.startTime-=e}},{key:"getTime",value:function(e){return q.call(this,e)}},{key:"getTiming",value:function(e){return B.call(this,e)}},{key:"createBaseNote",value:function(e,t,a,i,n){return I.call(this,e,t,a,i,n)}},{key:"createNote",value:function(e){return O.call(this,e)}},{key:"createPercussionNote",value:function(e){return S.call(this,e)}},{key:"stopAudioNode",value:function(e,t,a,i){return W.call(this,e,t,a,i)}},{key:"pushFunc",value:function(e){return L.call(this,e)}},{key:"clearFunc",value:function(e,t){return E.call(this,e,t)}},{key:"startWebMIDI",value:function(){return j.call(this)}},{key:"addEventListener",value:function(e,t){this.events.push({type:e,func:t})}},{key:"removeEventListener",value:function(e,t){for(var a=this.events.length;a>=0;a--)event.type==e&&event.func===t&&this.events.splice(a,1)}},{key:"removeAllEventListener",value:function(e){for(var t=this.events.length;t>=0;t--)event.type==e&&this.events.splice(t,1)}},{key:"fireEvent",value:function(e,t){this.events.forEach((function(a){if(a.type==e)try{a.func(t)}catch(e){console.log(e)}}))}},{key:"setOnSongEndListener",value:function(e){this.onSongEndListener=e}},{key:"onSongEnd",value:function(){if(this.onSongEndListener&&this.onSongEndListener())return;this.settings.loop&&(this.initStatus(!0),this.settings.isCC111&&-1!=this.cc111Time&&this.setStartTime(this.cc111Time),this.play(!0))}},{key:"getChannels",value:function(){return this.channels}},{key:"setChannels",value:function(e){var t=this;e.forEach((function(e,a){t.channels[a]=e}))}},{key:"initChannels",value:function(){for(var e=0;e<16;e++)this.channels[e]=[0,0,1]}},{key:"getMasterVolume",value:function(){return this.settings.masterVolume}},{key:"setMasterVolume",value:function(e){this.settings.masterVolume=e,this.isStarted&&(this.masterGainNode.gain.value=this.settings.masterVolume)}},{key:"isLoop",value:function(){return this.settings.loop}},{key:"setLoop",value:function(e){this.settings.loop=e}},{key:"isWebMIDI",value:function(){return this.settings.isWebMIDI}},{key:"setWebMIDI",value:function(e){this.settings.isWebMIDI=e}},{key:"isCC111",value:function(){return this.settings.isCC111}},{key:"setCC111",value:function(e){this.settings.isCC111=e}},{key:"isReverb",value:function(){return this.settings.isReverb}},{key:"setReverb",value:function(e){this.settings.isReverb=e}},{key:"getReverbVolume",value:function(){return this.settings.reverbVolume}},{key:"setReverbVolume",value:function(e){this.settings.reverbVolume=e}},{key:"isChorus",value:function(){return this.settings.isChorus}},{key:"setChorus",value:function(e){this.settings.isChorus=e}},{key:"getChorusVolume",value:function(){return this.settings.chorusVolume}},{key:"setChorusVolume",value:function(e){this.settings.chorusVolume=e}}]),e}()}();
