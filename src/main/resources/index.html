<!DOCTYPE html>
<html>

<head>
    <title>JMBox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#00796b" />
</head>

<body>
    <style>
        #bar {
            display: flex;
            flex-direction: row;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 999;
            background-color: #e0f2f1;
            width: 100%;
            box-shadow: 0 -4px 8px 0 rgb(0 0 0 / 10%);
        }

        .icon {
            font-size: 3vh;
            text-decoration: none;
            background-color: #00796b;
            color: white;
            border-radius: 4px;
            width: 4vh;
            height: 4vh;
            text-align: center;
            margin: 5px;
        }

        #audio {
            width: 100%;
        }

        #content {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-bottom: 60px;
        }

        .button {
            background-color: #00796b;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        }

        .button:hover {
            background-color: #009688;
        }

        .link {
            padding: 5px 16px;
            margin: 4px 2px;
            transition-duration: 0.4s;
            display: flex;
            align-items: center;
            min-height: 40px;
        }

        body {
            background-color: #b2dfdb;
            font-family: sans;
        }

        @media only screen and (min-width: 768px) {
            .link {
                width: 50vw;
            }

            #content {
                align-items: center;
            }
        }
    </style>
    <div id="bar">
        <audio controls autoplay id="audio"></audio>
        <a id="loop" class="icon button">&#11119;</a> <a id="wav" class="icon button">&#8767</a> <a id="mid"
            class="icon button">&#9835;</a>
    </div>
    <div id="content"></div>
    <script>
        let serverName = "JMBox";


        let content = document.getElementById("content");
        let audio = document.getElementById("audio");
        let wav = document.getElementById("wav");
        let mid = document.getElementById("mid");
        let loop = document.getElementById("loop");

        let cd = [];
        let files = [];
        let playing = [];

        let musicLoop = true;

        let prefix = location.pathname;
        let urlDir = location.hash.substring(1);

        function info() {
            fetch('api/info').then(r => r.json()).then(result => {
                serverName = result.serverName;
                document.title = serverName;

                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata.album = serverName;
                }
            });
        }

        function list(dir, add = true) {
            let cwd = concatDir(dir);
            fetch("api/list/" + cwd)
                .then(response => response.json())
                .then(result => {
                    if (add && dir != "") {
                        cd.push(dir);
                        window.scrollTo(0, 0);
                    }

                    location.href = prefix + "#/" + cwd;
                    content.innerHTML = '';

                    if (cd.length > 0) {
                        let updir = document.createElement("div");
                        updir.setAttribute("class", "link button");
                        updir.innerText = "..";
                        updir.setAttribute("onclick", "back();");
                        content.appendChild(updir);
                    }

                    result.sort((a, b) => {
                        let av = a.isDir ? -1000 : 0;
                        let bv = b.isDir ? -1000 : 0;
                        return a.name.localeCompare(b.name) + (av - bv);
                    });

                    files = [];

                    result.forEach(element => {
                        let file = document.createElement("div");
                        file.setAttribute("class", "link button");
                        if (element.isDir) {
                            file.innerText = "\u26D8 " + element.name;
                            file.setAttribute("onclick", `list("${element.name}");`);
                        } else {
                            file.innerText = "\u266b " + element.name;
                            file.setAttribute("onclick", `play("${element.name}");`);
                            files.push(element.name);
                        }
                        content.appendChild(file);
                    });
                });
        }

        function concatDir(dir) {
            let base = cd.join('/');
            if (cd.length > 0) {
                base += "/";
            }
            return base + encodeURIComponent(dir);
        }

        function back() {
            cd.pop();
            list('', false);
        }

        function play(file) {
            let url = "api/play/" + concatDir(file);
            console.log(file);

            document.title = serverName + " - " + file;
            audio.src = url;
            audio.loop = musicLoop;
            wav.setAttribute("href", "api/play/" + concatDir(file));
            mid.setAttribute("href", "api/midi/" + concatDir(file));
            playing = files.indexOf(file);

            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata.title = file;
                navigator.mediaSession.playbackState = 'playing';
            }
        }

        function next() {
            playing++;
            if (playing >= files.length) {
                playing = 0;
            }
            play(files[playing]);
        }

        function previous() {
            playing--;
            if (playing < 0) {
                playing = files.length - 1;
            }
            play(files[playing]);
        }

        function goto(dir) {
            let dirs = dir.split('/');
            cd = [];
            for (let dir of dirs) {
                if (dir != '') {
                    cd.push(dir);
                }
            }
        }

        loop.addEventListener('click', function (e) {
            musicLoop = !musicLoop;
            audio.loop = musicLoop;
            loop.style.backgroundColor = musicLoop ? '#00796b' : '#616161';
        });

        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                artwork: [
                    { src: 'favicon.ico', type: 'image/x-icon' }
                ]
            });
            navigator.mediaSession.setActionHandler('play', () => {
                audio.play();
                navigator.mediaSession.playbackState = 'playing';
            });
            navigator.mediaSession.setActionHandler('pause', () => {
                audio.pause();
                navigator.mediaSession.playbackState = 'paused';
            });
            navigator.mediaSession.setActionHandler('stop', () => { audio.stop(); });
            navigator.mediaSession.setActionHandler('seekbackward', () => { audio.currentTime -= 5; });
            navigator.mediaSession.setActionHandler('seekforward', () => { audio.currentTime += 5; });
            navigator.mediaSession.setActionHandler('seekto', () => { });
            navigator.mediaSession.setActionHandler('nexttrack', next);
            navigator.mediaSession.setActionHandler('previoustrack', previous);
        }

        if (urlDir != null)
            goto(urlDir);

        list('', false);
        setTimeout(info, 1000);
    </script>
</body>

</html>