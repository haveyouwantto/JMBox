<HTML>

<HEAD>

  <TITLE>Magenta MIDI Player</TITLE>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#f05477" />
  <script
    src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>
  <style type="text/css">
    html {
      background-color: #222;
    }

    .item {
      color: white;
      border: 1px solid white;
      margin: 3px;
      width: 16em;
      height: 1.5em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 5px;
      display: inline-block;
      cursor: pointer;
      font-family: sans;
    }

    .item:hover {
      color: #f05477;
      border: 1px solid #f05477;
    }

    @media only screen and (max-width: 768px) {
      #view {
        display: flex;
        flex-direction: column;
      }

      .item {
        width: auto;
      }
    }

    svg rect.note {
      opacity: 1;
    }

    svg rect.note.active {
      stroke: white;
      stroke-width: 1.5;
      stroke-opacity: 1;
    }
  </style>
</HEAD>

<body>

  <span id="view">

  </span><br>
  <midi-player autoplay sound-font visualizer="#myVisualizer" id="player">
  </midi-player>
  <midi-visualizer type="piano-roll" id="myVisualizer"></midi-visualizer>
  <script>
    class URLManager {
      constructor() {
        this.cd = [];
      }
      getPath() {
        let base = "/" + this.cd.join('/');
        return encodeURI(base);
      }
      add(dir) {
        this.cd.push(dir);
      }
      remove() {
        this.cd.pop();
      }
      setPath(path) {
        let dirs = path.split('/');
        this.cd = [];
        for (let dir of dirs) {
          if (dir != '') {
            this.cd.push(decodeURIComponent(dir));
          }
        }
      }

      isRoot() {
        return this.cd.length == 0;
      }
    }


    let url = new URLManager();
    let view = document.getElementById('view');
    let player = document.getElementById('player');
    let visualizer = document.getElementById('myVisualizer');
    let display = visualizer.querySelector('div');
    let urlDir = location.hash.substring(1);

    visualizer.config = {
      pixelsPerTimeStep: 100
    }

    let colors = [
      'f44336', 'ff5722', 'ff9800', 'ffc107',
      'ffeb3b', 'cddc39', '8bc34a', '4caf50',
      '009688', '00bcd4', '03a9f4', '2196f3',
      '3f51b5', '673ab7', '9c27b0', 'e91e63',

      'ef5350', 'ff7043', 'ffa726', 'ffca28',
      'ffee58', 'd4e157', '9ccc65', '66bb6a',
      '26a69a', '26c6da', '29b6f6', '42a5f5',
      '5c6bc0', '7e57c2', 'ab47bc', 'ec407a',

      'e57373', 'ff8a65', 'ffb74d', 'ffd54f',
      'fff176', 'dce775', 'aed581', '81c784',
      '4db6ac', '4dd0e1', '4fc3f7', '64b5f6',
      '7986cb', '9575cd', 'ba68c8', 'f06292',

      'ef9a9a', 'ffab91', 'ffcc80', 'ffe082',
      'fff59d', 'e6ee9c', 'c5e1a5', 'a5d6a7',
      '80cbc4', '80deea', '81d4fa', '90caf9',
      '9fa8da', 'b39ddb', 'ce93d8', 'f48fb1'
    ];

    let style = document.createElement('style');
    let c = [];
    for (let i = 0; i < colors.length; i++) {
      let color = colors[i];
      c.push(
        'svg rect.note[data-instrument="' + i + '"]{fill:#' + color + ';}'
      );
    }
    c.push('svg rect.note[data-is-drum="true"] {fill: white;}');
    c.push('svg rect.note.active[data-is-drum="true"]  {fill: #f05477;stroke:none;}');
    style.innerText = c.join('');
    visualizer.appendChild(style);

    player.addEventListener('start', e => {
      display.scrollTo(0, 0);
    });

    function list() {
      fetch("/api/list" + url.getPath())
        .then(response => response.json())
        .then(result => {
          view.innerHTML = '';

          if (!url.isRoot()) {
            let updir = document.createElement("div");
            updir.setAttribute("class", "item");
            updir.innerText = "..";
            updir.setAttribute("onclick", "back();");
            view.appendChild(updir);
          }

          result.sort((a, b) => {
            let av = a.isDir ? -1000 : 0;
            let bv = b.isDir ? -1000 : 0;
            return a.name.localeCompare(b.name) + (av - bv);
          });

          for (let e of result) {

            let div = document.createElement('div');
            div.setAttribute('name', e.name);
            div.setAttribute('class', 'item');
            if (e.isDir) {
              div.innerText = '\u2588 ' + e.name;
              div.setAttribute('onclick', 'elist(this);');
            } else {
              div.innerText = e.name;
              div.setAttribute('onclick', 'eplay(this);');
            }
            view.appendChild(div);
          }
          location.hash = url.getPath();
        });
    }

    function play(file) {
      player.setAttribute("src", "/api/midi" + url.getPath() + '/' + encodeURIComponent(file));
    }

    function elist(e) {
      url.add(e.getAttribute('name'));
      list();
    }

    function back() {
      url.remove();
      list();
    }

    function eplay(e) {
      play(e.getAttribute("name"));
    }

    if (urlDir != null)
      url.setPath(urlDir);

    list();
  </script>
</body>

</HTML>